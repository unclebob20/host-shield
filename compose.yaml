services:
  # 1. Database: Native ARM64 (Works fine)
  db:
    image: postgres:15-alpine
    container_name: hostshield_db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: hostshield
    volumes:
      - ./databse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"

  # 2. OCR Sidecar: Emulate x86_64
  ocr-engine:
    platform: linux/amd64
    image: tesseractshadow/tesseract4re:latest
    container_name: hostshield_ocr
    volumes:
      - ./samples:/tmp/samples

  # 3. Gov-Bridge: Slovensko.digital official GHCR image
  gov-bridge:
    platform: linux/amd64
    image: ghcr.io/slovensko-digital/slovensko-sk-api:latest
    container_name: hostshield_gov_api
    environment:
      - API_TOKEN=test_token_123
      - RAILS_ENV=production
      - SECRET_KEY_BASE=a_random_string_of_at_least_32_chars
      - RAILS_LOG_TO_STDOUT=true
    volumes:
      # This line replaces the broken file inside the container with your new one
      - ./gov_db.yml:/app/config/database.yml:ro
    ports:
      - "3001:3000"

  # 4. MRZ Reader: PassportEye microservice for production-grade MRZ extraction
  mrz-reader:
    build: ./apps/api-server/src/services/mrz-reader
    container_name: hostshield_mrz
    ports:
      - "8001:8000"

  # 5. Your API Server: Runs natively (No platform flag needed)
  api-server:
    build: ./apps/api-server
    container_name: hostshield_api
    environment:
      - DATABASE_URL=postgresql://user:password@hostshield_db:5432/hostshield
      - OCR_ENGINE_URL=http://hostshield_ocr:8080
      - MRZ_READER_URL=http://hostshield_mrz:8000
      - BRIDGE_BASE_URL=http://hostshield_gov_api:3000/api
      - BRIDGE_API_TOKEN=test_token_123
    ports:
      - "3000:3000"
    depends_on:
      - db
      - mrz-reader

  # 6. Web Client (Frontend)
  web-client:
    build: ./apps/web-client
    container_name: hostshield_web
    ports:
      - "5173:5173"
    environment:
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - ./apps/web-client:/app
      - /app/node_modules
    command: npm run dev -- --host
    depends_on:
      - api-server
