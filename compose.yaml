services:
  # 1. Database: Native ARM64 (Works fine)
  db:
    image: postgres:15-alpine
    container_name: hostshield_db
    environment:
      POSTGRES_USER: ${DB_USER:-user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
      POSTGRES_DB: hostshield
    volumes:
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"

  # 2.5 Redis for Gov Bridge Token Cache
  redis:
    image: redis:7-alpine
    container_name: hostshield_gov_redis
    ports:
      - "6379:6379"

  # 2.6 Postgres for Gov Bridge (if needed)
  gov-db:
    image: postgres:15-alpine
    container_name: hostshield_gov_db
    environment:
      POSTGRES_USER: ${GOV_DB_USER:-gov_user}
      POSTGRES_PASSWORD: ${GOV_DB_PASSWORD:-gov_password}
      POSTGRES_DB: gov_api_production
    ports:
      - "5433:5432"

  # 3. Gov-Bridge: Slovensko.digital official GHCR image
  gov-bridge:
    platform: linux/amd64
    image: ghcr.io/slovensko-digital/slovensko-sk-api:latest
    container_name: hostshield_gov_api
    depends_on:
      - redis
      - gov-db
    environment:
      - API_TOKEN=test_token_123
      - RAILS_ENV=production
      - UPVS_ENV=prod
      - SECRET_KEY_BASE=a_random_string_of_at_least_32_chars
      - RAILS_LOG_TO_STDOUT=true
      - REDIS_URL=redis://hostshield_gov_redis:6379/1
      - DATABASE_URL=postgres://${GOV_DB_USER:-gov_user}:${GOV_DB_PASSWORD:-gov_password}@gov-db:5432/gov_api_production
    volumes:
      # Removed the SQLite override
      - ./security/gov_fake_public.pem:/app/security/api_token_production.public.pem:ro
      - ./security/host_shield_test_prod.keystore:/app/security/sts/host_shield_test_prod.keystore:ro
      - ./security/host_shield_test_dev.keystore:/app/security/sts/host_shield_test_dev.keystore:ro
      - ./security/iscep_test_subject_prod.keystore:/app/security/sts/iscep_test_subject_prod.keystore:ro
      - ./security/iscep_test_subject_dev.keystore:/app/security/sts/iscep_test_subject_dev.keystore:ro
    ports:
      - "3001:3000"

  # 4. MRZ Reader: PassportEye microservice for production-grade MRZ extraction
  mrz-reader:
    build: ./apps/api-server/src/services/mrz-reader
    container_name: hostshield_mrz
    restart: unless-stopped
    ports:
      - "8001:8000"

  # 5. Your API Server: Runs natively (No platform flag needed)
  api-server:
    build: ./apps/api-server
    container_name: hostshield_api
    environment:
      - DATABASE_URL=postgresql://${DB_USER:-user}:${DB_PASSWORD:-password}@hostshield_db:5432/hostshield
      - MRZ_READER_URL=http://hostshield_mrz:8000
      - BRIDGE_BASE_URL=http://hostshield_gov_api:3000/api

      - BRIDGE_PRIVATE_KEY_PATH=/app/security/gov_fake_private.key
    volumes:
      - ./security:/app/security:ro
    ports:
      - "3000:3000"
    depends_on:
      - db
      - mrz-reader

  # 6. Web Client (Frontend)
  web-client:
    build: ./apps/web-client
    container_name: hostshield_web
    ports:
      - "5173:5173"
    environment:
      - VITE_API_TARGET=http://hostshield_api:3000
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - ./apps/web-client:/app
      - /app/node_modules
    command: npm run dev -- --host
    depends_on:
      - api-server
